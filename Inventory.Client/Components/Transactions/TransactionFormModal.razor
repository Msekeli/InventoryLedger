@using Inventory.Client.Models.Transactions
@inject IStockTransactionService TransactionService

<!-- Toast -->
@if (showToast)
{
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 4000;">
        <div class="toast show text-bg-success border-0 shadow">
            <div class="toast-body d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-2"></i>
                @toastMessage
            </div>
        </div>
    </div>
}

<!-- Modal -->
<div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Add Transaction</h5>
                <button class="btn-close" @onclick="Close"></button>
            </div>

            <div class="modal-body">

                <div class="mb-3">
                    <label class="form-label">Transaction Type</label>
                    <select class="form-select" @bind="Model.Type">
                        <option value="IN">IN (Add Stock)</option>
                        <option value="OUT">OUT (Reduce Stock)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Quantity</label>
                    <input class="form-control" type="number" @bind="Model.Quantity" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Remarks</label>
                    <input class="form-control" @bind="Model.Remarks" />
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" @onclick="Save" disabled="@busy">
                    @(busy ? "Saving..." : "Save")
                </button>
                <button class="btn btn-secondary" @onclick="Close" disabled="@busy">Cancel</button>
            </div>

        </div>
    </div>
</div>

@code {
    [Parameter] public int ItemId { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private CreateStockTransactionDto Model = new();
    private bool busy = false;

    // Toast
    private bool showToast = false;
    private string toastMessage = "";

    protected override void OnInitialized()
    {
        Model.ItemId = ItemId;
        Model.Type = "IN";
    }

    private async Task Save()
    {
        busy = true;

        try
        {
            if (Model.Quantity <= 0)
            {
                busy = false;
                return;
            }

            var ok = await TransactionService.CreateAsync(Model);

            if (ok)
            {
                await ShowToast("Transaction saved");
                await Task.Delay(300);
                await OnSaved.InvokeAsync();
            }
        }
        finally
        {
            busy = false;
            await OnClose.InvokeAsync();
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private async Task ShowToast(string message)
    {
        toastMessage = message;
        showToast = true;
        StateHasChanged();

        await Task.Delay(2000);

        showToast = false;
        StateHasChanged();
    }
}
